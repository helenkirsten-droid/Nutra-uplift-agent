<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nutra Uplift Agent – Single‑File</title>
<style>
  body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; line-height: 1.45; }
  h1 { font-size: 20px; margin: 0 0 8px; }
  .sub { color:#555; margin-bottom: 20px; }
  .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); background: #fff; }
  .row { display: grid; grid-template-columns: 220px 1fr; gap: 8px; margin: 6px 0; align-items: center; }
  input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
  input[type="file"], button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background: #f8f8f8; cursor: pointer; }
  button.primary { background: #0b6cff; color: #fff; border-color: #0b6cff; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
  th, td { border: 1px solid #eee; padding: 8px; text-align: left; }
  th { background: #fafafa; position: sticky; top: 0; }
  td[contenteditable="true"] { background: #fffef5; }
  .metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 8px; }
  .metric { background: #f7faff; border: 1px solid #e0ecff; padding: 12px; border-radius: 10px; }
  .muted { color:#666; font-size: 12px; }
  .footer { margin-top: 18px; color:#666; font-size: 12px; }
</style>
</head>
<body>
  <h1>Nutra Uplift Agent</h1>
  <div class="sub">Upper‑funnel proxy sales calculator – no installs – runs in your browser.</div>

  <div class="grid">
    <div class="card">
      <strong>Global Inputs</strong>
      <div class="row"><label>Base revenue (May–Aug)</label><input id="baseRev" type="number" step="1000" value="10000000"></div>
      <div class="row"><label>Average order value (AOV)</label><input id="aov" type="number" step="0.1" value="22.4"></div>
      <div class="row"><label>Gross margin</label><input id="margin" type="number" step="0.01" value="0.62"></div>
      <div class="row"><label>Total addressable audience</label><input id="taa" type="number" step="1000" value="3000000"></div>
      <div class="row"><label>Overlap factor (reach% sum)</label><input id="overlap" type="number" step="0.01" value="0.60"></div>
      <div class="row"><label>Conversion lift % (exposed)</label><input id="liftPct" type="number" step="0.001" value="0.07"></div>
      <div class="row"><label>Brand‑lag multiplier</label><input id="lag" type="number" step="0.5" value="7"></div>
      <button class="primary" onclick="recalc()">Recalculate</button>
    </div>
    <div class="card">
      <strong>Channels CSV</strong>
      <p class="muted">Use the template columns below. You can also edit the table inline.</p>
      <input id="file" type="file" accept=".csv" />
      <div style="margin-top:8px;">
        <button onclick="downloadCSV()">Download current table</button>
        <button onclick="resetTable()">Reset to defaults</button>
      </div>
      <div class="muted" style="margin-top:8px;">Columns:
        Channel, Activity_Type, Measurement, Formats, Budget, Impressions, Frequency, Reach, Clicks, Exposure_Rate_Assump, Conv_Proxy_Assump
      </div>
    </div>
    <div class="card">
      <strong>Results</strong>
      <div class="metrics">
        <div class="metric"><div>Sum of Budgets</div><div id="m_budget"><b>$0</b></div></div>
        <div class="metric"><div>Impressions</div><div id="m_imps"><b>0</b></div></div>
        <div class="metric"><div>Reach</div><div id="m_reach"><b>0</b></div></div>
        <div class="metric"><div>Effective Reach %</div><div id="m_effreach"><b>0%</b></div></div>
        <div class="metric"><div>Direct proxy – revenue</div><div id="m_dirrev"><b>$0</b></div></div>
        <div class="metric"><div>Direct proxy – profit</div><div id="m_dirprof"><b>$0</b></div></div>
        <div class="metric"><div>Lift model – revenue</div><div id="m_liftrev"><b>$0</b></div></div>
        <div class="metric"><div>Lift model – profit</div><div id="m_liftprof"><b>$0</b></div></div>
        <div class="metric"><div>Long‑term (lag) – revenue</div><div id="m_longrev"><b>$0</b></div></div>
      </div>
      <div class="metrics" style="margin-top:12px;">
        <div class="metric"><div>Direct ROAS</div><div id="m_roas_dir"><b>0.00x</b></div></div>
        <div class="metric"><div>Lift ROAS (short‑term)</div><div id="m_roas_lift"><b>0.00x</b></div></div>
        <div class="metric"><div>Lift ROAS (long‑term)</div><div id="m_roas_long"><b>0.00x</b></div></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <strong>Channels</strong>
    <table id="table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="footer">Tip – send this file by email or chat. Anyone can open it in a browser and use it offline.</div>

<script>
const headers = ["Channel","Activity_Type","Measurement","Formats","Budget","Impressions","Frequency","Reach","Clicks","Exposure_Rate_Assump","Conv_Proxy_Assump"];

const defaults = [
  ["BVOD","Media","Reach","15\" & 30\" TVC",90900,1790724,5,358145,0,0.80,0.0006],
  ["Podcast Sponsorship","Media","Reach","Podcast Sponsorship",50000,100000,5,20000,0,0.85,0.0004],
  ["Broadsheet Partnership","Media","Engagement","Broadsheet Partnership",100000,966000,5,193200,9660,0.50,0.0012],
  ["Linkby","Media","Reach","Linkby",50000,1000000,5,200000,0,0.50,0.0010],
  ["CTV (Programmatic)","Programmatic","Reach","15\" & 30\" TVC",325000,5700000,8,712500,0,0.70,0.0006],
  ["Programmatic Audio","Programmatic","Reach","15\" & 30\" Audio Ads",50000,1645714,8,205714,0,0.85,0.0004],
  ["Programmatic OOH","Programmatic","Reach","Digital - Small Format, Billboards, Retail",174800,1700000,10,170000,0,0.65,0.0003],
];

function fmtMoney(x){ return isFinite(x) ? "$"+Number(x).toLocaleString() : "$0"; }
function fmtNum(x){ return isFinite(x) ? Number(x).toLocaleString() : "0"; }
function fmtPct(x){ return isFinite(x) ? (x*100).toFixed(2)+"%" : "0.00%"; }
function toNum(v){ const n = parseFloat(v); return isFinite(n) ? n : 0; }

function buildTable() {
  const thead = document.querySelector("#table thead");
  const tbody = document.querySelector("#table tbody");
  thead.innerHTML = "<tr>" + headers.map(h=>`<th>${h}</th>`).join("") + "</tr>";
  tbody.innerHTML = "";
  defaults.forEach(row => addRow(row));
}

function addRow(data) {
  const tbody = document.querySelector("#table tbody");
  const tr = document.createElement("tr");
  headers.forEach((h, idx) => {
    const td = document.createElement("td");
    td.contentEditable = "true";
    td.textContent = data[idx];
    tbody.appendChild(tr);
    tr.appendChild(td);
  });
}

function readTable() {
  const rows = [];
  document.querySelectorAll("#table tbody tr").forEach(tr => {
    const cols = Array.from(tr.children).map(td => td.textContent.trim());
    rows.push(cols);
  });
  return rows;
}

function recalc() {
  const baseRev = toNum(document.getElementById("baseRev").value);
  const aov = toNum(document.getElementById("aov").value);
  const margin = toNum(document.getElementById("margin").value);
  const taa = Math.max(1, toNum(document.getElementById("taa").value));
  const overlap = toNum(document.getElementById("overlap").value);
  const liftPct = toNum(document.getElementById("liftPct").value);
  const lag = toNum(document.getElementById("lag").value);

  const rows = readTable();
  let sumBudget=0, sumImps=0, sumReach=0, sumReachPct=0, directRevenue=0;

  rows.forEach(r => {
    const Budget = toNum(r[4]);
    const Imps = toNum(r[5]);
    const Reach = toNum(r[7]);
    const Exposure = toNum(r[9]);
    const Conv = toNum(r[10]);

    const reachPct = Reach / taa;
    const effectiveExposures = Reach * Exposure;
    const incSales = effectiveExposures * Conv * aov;

    sumBudget += Budget;
    sumImps += Imps;
    sumReach += Reach;
    sumReachPct += reachPct;
    directRevenue += incSales;
  });

  const effectiveReachPct = Math.min(1, overlap * sumReachPct);
  const directProfit = directRevenue * margin;
  const liftRevenue = baseRev * effectiveReachPct * liftPct;
  const liftProfit = liftRevenue * margin;
  const longRev = liftRevenue * lag;
  const roasDirect = sumBudget>0 ? (directRevenue/sumBudget) : 0;
  const roasLift = sumBudget>0 ? (liftRevenue/sumBudget) : 0;
  const roasLong = sumBudget>0 ? (longRev/sumBudget) : 0;

  document.getElementById("m_budget").innerHTML = "<b>"+fmtMoney(sumBudget)+"</b>";
  document.getElementById("m_imps").innerHTML = "<b>"+fmtNum(sumImps)+"</b>";
  document.getElementById("m_reach").innerHTML = "<b>"+fmtNum(sumReach)+"</b>";
  document.getElementById("m_effreach").innerHTML = "<b>"+fmtPct(effectiveReachPct)+"</b>";
  document.getElementById("m_dirrev").innerHTML = "<b>"+fmtMoney(directRevenue)+"</b>";
  document.getElementById("m_dirprof").innerHTML = "<b>"+fmtMoney(directProfit)+"</b>";
  document.getElementById("m_liftrev").innerHTML = "<b>"+fmtMoney(liftRevenue)+"</b>";
  document.getElementById("m_liftprof").innerHTML = "<b>"+fmtMoney(liftProfit)+"</b>";
  document.getElementById("m_longrev").innerHTML = "<b>"+fmtMoney(longRev)+"</b>";
  document.getElementById("m_roas_dir").innerHTML = "<b>"+roasDirect.toFixed(2)+"x</b>";
  document.getElementById("m_roas_lift").innerHTML = "<b>"+roasLift.toFixed(2)+"x</b>";
  document.getElementById("m_roas_long").innerHTML = "<b>"+roasLong.toFixed(2)+"x</b>";
}

function csvToRows(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  const rows = lines.map(l => {
    // simple CSV split (no quoted commas)
    return l.split(",").map(x=>x.trim());
  });
  return rows;
}

function rowsToCSV(rows){
  return rows.map(r => r.map(v => ("," in v ? `"${v.replace(/"/g,'""')}"` : v)).join(",")).join("\n");
}

document.getElementById("file").addEventListener("change", (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    const rows = csvToRows(reader.result);
    // if first row is headers, skip
    let start = 0;
    const h = rows[0] || [];
    if (h.length>=headers.length && headers.every((x,i)=> (h[i]||"").toLowerCase()===x.toLowerCase())) {
      start = 1;
    }
    // overwrite table
    const tbody = document.querySelector("#table tbody");
    tbody.innerHTML="";
    for(let i=start;i<rows.length;i++){
      const row = rows[i];
      const filled = headers.map((h,idx)=> row[idx]!==undefined ? row[idx] : "");
      addRow(filled);
    }
    recalc();
  };
  reader.readAsText(f);
});

function downloadCSV(){
  const rows = [headers, ...readTable()];
  const blob = new Blob([rowsToCSV(rows)], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "channels_out.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function resetTable(){
  const tbody = document.querySelector("#table tbody");
  tbody.innerHTML="";
  defaults.forEach(r => addRow(r));
  recalc();
}

// init
buildTable();
recalc();
</script>
</body>
</html>
